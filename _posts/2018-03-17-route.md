---
title: route
date: 2018-03-17
tags: [Linux, web]
---

内容: 解释了路由以及route命令使用

精华: 理清了路由和网关区别, 路由分类清晰, 详细解释了路由项持久化存储, route命令解释详细

<!-- more -->

# 概述

查看修改本机路由表

![](http://p1rbtn7qp.bkt.clouddn.com/18-3-16/22719765.jpg)

* Genmask: 就是子网掩码
* Flags
    * U: 路由是活动的
    * G: 路由指向网关
    * H: 目标是一个主机
    * R: 恢复动态路由产生的表项
    * D: 由路由的后台程序动态地安装
    * M: 由路由的后台程序修改
    * !: 拒绝路由
* Metric: 度量, 一般是跳数
* Ref: 路由项引用次数
* Use: 此路由项被路由软件查找的次数
* Iface: 输出接口
 
这个命令查看的是本机路由表

路由器需要路由表来根据数据包目的地转发到下一个路由/主机

本机需要路由表来根据数据包目的地将数据包发送到第一个路由(但是注意, 本机没有路由寻址功能, 本机路由表仅供自己发送数据, 无法将本机作为路由器来路由别人的数据, 当然, 想开启路由寻址也可以)

## 网关和路由

首先, 网关是个泛概念, 不具体指, 所有连接两个网络的都算网关, 所以路由也是网关

一般网关路由不用区别

只有一种情况要区分开网关和路由

PC1-----R1-----R2-----R3-----PC2

此时说R1是PC1的默认网关, R3是PC2的默认网关, 但是R2就不是网关, 只是个路由

另外, 似乎这时的网关专指默认网关, 比如, 本机会有很多直接关联的路由, 只有默认网关叫网关, 其他还是叫路由

# 三种路由类型

## 主机路由

```
Destination    Gateway          Genmask      Flags    Metric    Ref     Use   Iface
-----------  -----------    ---------------  ------   -------  -----   ------  ----
 10.0.0.10   192.168.1.1    255.255.255.255    UH        0       0        0    eth0
```

主机路由
:   指该路由项(路由项就是路由表一行)是发往一台主机的(感觉准确说是发往一台主机的默认网关的)

主机路由Flags为H

如上表示: 本机可以从eth0接口, 发到192.168.1.1这个目的主机的默认网关, 转到10.0.0.10/255.255.255.255这个主机

这个192.168.1.1也就是这台主机的默认网关了

注意这里的子网掩码是255.255.255.255, 明显是个主机

## 网络路由

```
Destination    Gateway          Genmask      Flags    Metric    Ref     Use   Iface
-----------  -----------    ---------------  ------   -------  -----   ------  ----
 192.19.12   192.168.1.1     255.255.255.0     UN        0       0        0    eth0
```

网络路由
:   指该路由项是发往一个网段的入口路由器

网络路由Flags为N

每经过一个路由器, 源目的ip不变, 源目的mac修改为两个路由器的接口mac

所以, 这里的Destination是最终目的网络(可能是网络内的群发消息), Gateway是下一个网段的入口路由, 而非目的网络的默认网关

注意这里的子网掩码是255.255.255.0, 明显是个网段

## 默认路由

```
Destination    Gateway     Genmask    Flags    Metric    Ref     Use   Iface
-----------  -----------  ----------  ------   -------  -----   ------  ----
  default    192.168.1.1    0.0.0.0     UG        0       0        0    eth0
```

默认路由
:   也就是本机的默认网关, 没有匹配的路由项, 就发到默认路由

本机发出的数据包, 如果目的地没有哪个路由匹配, 就从eth0发到默认网关192.168.1.1

子网掩码是0.0.0.0, 没有特殊含义, 并不用和默认网关ip来做与运算, 0.0.0.0只是用来特指默认网关的子网掩码

同时, 如果`route -n`会发现default的值也是0.0.0.0

这个有一定含义, 并不是真的ip, 也不是网段, 而是指代所有ip

这样就可以理解, 哪怕数据包目的地不匹配其他所有路由, 对于这个0.0.0.0, 数据包目的地ip也一定匹配, 所以就会被发往默认网关192.168.1.1(另外, 路由项不是先到先得, 默认路由在第一位没影响, 记得是最长匹配优先)

## 其他

另外除了默认路由还可以看到有两个路由项

![](http://p1rbtn7qp.bkt.clouddn.com/18-3-16/22719765.jpg)

可以看到网关路由都是0.0.0.0, 应该是发到默认网关

# 修改路由表

```
route [add|del] [-net|-host] target [netmask Nm] [gw Gw] [[dev] If]
```

* add: 添加一条路由项
* del: 删除一条路由项
* -net: destination 目的地址是一个网络
* -host: destination 目的地址是一个主机
* target: 目的网络或主机
* netmask: 目的地址的网络掩码
* gw: 路由数据包通过的网关
* dev: 为路由指定的网络接口
 
## 添加/删除路由项

```
//添加到主机的路由
route add -host 139.198.199.163 gw 10.20.30.41

//添加到网络的路由
route add -net 10.20.30.48 netmask 255.255.255.248 gw 10.20.30.41
route add -net 10.20.30.48/29 gw 10.20.30.41

//添加默认路由
route add default gw 10.20.30.41
```

删除就把`add`换成`del`

![](http://p1rbtn7qp.bkt.clouddn.com/18-3-17/40527132.jpg)

如上, 默认路由可以添加多个

* 如果缺省网卡接口, 会选择默认网卡
* 如果缺省网关, 会置为0.0.0.0

## 屏蔽路由

![](http://p1rbtn7qp.bkt.clouddn.com/18-3-17/36824678.jpg)

如上, 发往192.168.122.4的数据包会被拒绝

gateway处显示-

## 设置包转发

```
//检测是否开启包转发, 为1开启
sysctl net.ipv4.ip_forward
//手动开启包转发(重启后无效)
sysctl -w net.ipv4.ip_forward=1


//永久生效
vim /etc/sysctl.conf
net.ipv4.ip_forward = 1
```
# 路由规则永久保存

* /etc/rc.local
* /etc/profile
* /etc/sysconfig/static-router(不存在就自己建)
 
前两种显而易见, 重启网络服务后, 如果没有重启电脑, 就会失效

最后一种, 重启网络服务后依然生效

## /etc/sysconfig/static-router

先看下该文件的解析方式

在`/etc/init.d/network`里解析这个文件, 代码如下

![](http://p1rbtn7qp.bkt.clouddn.com/18-3-17/22201876.jpg)

读取所有any开头的行, 执行`route add -`

所以static-router文件内配置应该如下

```
any net 192.168.15.0/24 gw 192.168.14.254
any host 123.57.223.144 gw 192.168.14.254
any host 123.57.190.33/32 gw 192.168.8.1
```
